/**
 * Javascript Controller to embed GGBApplet
 *
 * This class provides all the functionality for the new assign module.
 *
 * @author         Christoph Stadlbauer <christoph.stadlbauer@geogebra.org>
 * @copyright  (c) International GeoGebra Institute 2018
 * @license        http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("qtype_geogebra/ggbt",["jquery","//www.geogebra.org/apps/deployggb.js"],(function($,GGBApplet){return{init:function(){window.GGBT=this,window.ggbAppletOnLoad=function(){if($('input[name="ggbparameters"]').val(JSON.stringify(window.applet1.getParameters())),$('input[name="ggbviews"]').val(JSON.stringify(window.applet1.getViews())),$('input[name="ggbcodebaseversion"]').val(window.applet1.getHTML5CodebaseVersion()),void 0===this.ggbcheckb){var applet=document.ggbApplet;$('input[name="ggbxml"]').val(applet.getXML()),$('input[name="ggbexercise"]').val(JSON.stringify(applet.getExerciseResult())),document.getElementById("id_randomizedvar").value||window.GGBT.getrandvars();for(var i=0,answer=$("#id_answer_"+i);void 0!==answer[0];)answer.val()&&(answer.on("change focus",(function(e){e.preventDefault(),window.GGBT.update_feedback($(e.target))})),window.GGBT.update_feedback(answer)),answer=$("#id_answer_"+ ++i);document.querySelector("article").onkeypress=window.GGBT.checkEnter}window.GGBT.usefile.checked&&(document.getElementById("applet_container1").style.display="block",document.getElementById("applet_options").style.display="flex")},void 0!==$("#applet_parameters")[0]&&(this.ggbDataset=$("#applet_parameters")[0].dataset,this.parameters=JSON.parse(this.ggbDataset.parameters),this.views=this.ggbDataset.views,window.applet1=new GGBApplet(this.parameters,this.views,!0),this.lang=this.ggbDataset.lang),$("#id_loadapplet").on("click",(function(e){e.preventDefault();var id=$("#id_ggbturl").val().split("/").pop();0==id.indexOf("m")&&(window.GGBT.isNumber(id.substr(1))||!window.GGBT.isNumber(id.substr(1))&&id.length>8)&&(id=id.substr(1)),window.GGBT.injectapplet(id)})),$("#id_getvars").on("click",(function(e){e.preventDefault(),window.GGBT.getrandvars()})),this.parameters&&window.applet1.inject("applet_container1","preferHTML5"),this.ggbf=document.getElementById("id_ggbtheader"),this.usefile=document.getElementById("id_usefile"),null===this.ggbf&&(this.ggbf=document.getElementById("id_submissiontypes"),this.ggbcheckb=document.getElementById("id_assignsubmission_geogebra_enabled"),null!==this.ggbcheckb&&this.ggbcheckb.addEventListener("change",this.handleggbdisable,!1)),null!==this.ggbf&&(this.ggbf.addEventListener("dragenter",this.handleDragEnter,!1),this.ggbf.addEventListener("dragover",this.handleDragOver,!1),this.ggbf.addEventListener("dragleave",this.handleDragEndLeave,!1),this.ggbf.addEventListener("dragend",this.handleDragEndLeave,!1),this.ggbf.addEventListener("drop",this.handleDrop,!1),this.usefile.addEventListener("change",this.handleusefile,!1)),this.usefile.checked?document.getElementById("applet_options").style.display="block":document.getElementById("applet_options").style.display="none",this.initoptions()},callback:function(params){var elementname=M.core_filepicker.instances[params.client_id].options.elementname;$("#id_"+elementname).val(params.url);var id=params.file.split(".")[0];0==id.indexOf("m")&&(this.isNumber(id.substr(1))||!this.isNumber(id.substr(1))&&id.length>8)&&(id=id.substr(1)),this.injectapplet(id)},injectapplet:function(id){this.parameters={material_id:id},this.parameters.language=this.lang,this.parameters.moodle="editingQuestionOrSubmission",this.parameters.useBrowserForJS=!1,document.getElementById("applet_container1").style.display="block",window.applet1=new GGBApplet(this.parameters,!0),window.applet1.inject("applet_container1","preferHTML5")},getrandvars:function(){var applet=document.ggbApplet;if(void 0!==applet)for(var objNumber=applet.getObjectNumber(),randomizedvar=document.getElementById("id_randomizedvar"),stringforrandomizedvars="",i=0,j=0;j<objNumber;j++){var strName=applet.getObjectName(j);if("numeric"==applet.getObjectType(strName)&&applet.isIndependent(strName))stringforrandomizedvars+=strName+",";else{var answer=$("#id_answer_"+i);"boolean"==applet.getObjectType(strName)&&null!==answer&&(answer.val()||answer.val(strName),this.update_feedback(answer),i++)}randomizedvar.value=stringforrandomizedvars}},update_feedback:function(answernode){var id=answernode.attr("id").split("_").pop(),varname=answernode.val(),feedback=$('input[name="feedback['+id+']"]'),feedbackfromfile=$("#id_feedbackfromfile_"+id),doc=$.parseXML(window.ggbApplet.getXML(varname));if(doc){var elem=doc.getElementsByTagName("caption"),fbstring="";1==elem.length?(fbstring=elem[0].getAttribute("val"),feedback.val(fbstring)):elem.length>1?(feedback.val(""),fbstring=""):(feedback.val(""),fbstring="Caption not set or variable name wrong."),feedbackfromfile.val(fbstring)}},checkEnter:function(e){return e=e||event,/textarea/i.test((e.target||e.srcElement).tagName)||13!==(e.keyCode||e.which||e.charCode||0)},initoptions:function(){this.enable_right_click=document.getElementById("enableRightClick"),this.enable_label_drags=document.getElementById("enableLabelDrags"),this.show_reset_icon=document.getElementById("showResetIcon"),this.enable_shift_drag_zoom=document.getElementById("enableShiftDragZoom"),this.show_algebra_input=document.getElementById("showAlgebraInput"),this.show_menu_bar=document.getElementById("showMenuBar"),this.show_tool_bar=document.getElementById("showToolBar"),"undefined"!=typeof parameters&&(this.enable_right_click.checked=this.parameters.enableRightClick,this.enable_label_drags.checked=this.parameters.enableLabelDrags,this.show_reset_icon.checked=this.parameters.showResetIcon,this.enable_shift_drag_zoom.checked=this.parameters.enableShiftDragZoom,this.show_algebra_input.checked=this.parameters.showAlgebraInput,this.show_menu_bar.checked=this.parameters.showMenuBar,this.show_tool_bar.checked=this.parameters.showToolBar),this.enable_right_click.addEventListener("change",this.handlesettingschanged,!1),this.enable_label_drags.addEventListener("change",this.handlesettingschanged,!1),this.show_reset_icon.addEventListener("change",this.handlesettingschanged,!1),this.enable_shift_drag_zoom.addEventListener("change",this.handlesettingschanged,!1),this.show_algebra_input.addEventListener("change",this.handlesettingschanged,!1),this.show_menu_bar.addEventListener("change",this.handlesettingschanged,!1),this.show_tool_bar.addEventListener("change",this.handlesettingschanged,!1)},handlesettingschanged:function(evt){window.GGBT.parameters[evt.target.id]=evt.target.checked,$('input[name="ggbparameters"]').val(JSON.stringify(window.GGBT.parameters)),"showToolBar"==evt.target.id||"showMenuBar"==evt.target.id||"showAlgebraInput"==evt.target.id?(window.applet1=new GGBApplet(window.GGBT.parameters,!0),window.applet1.inject("applet_container1","preferHTML5")):window.ggbApplet[evt.target.id](evt.target.checked)},handleusefile:function(){window.GGBT.usefile.checked?document.getElementById("id_ggbturl").value="":(document.getElementById("applet_container1").style.display="none",document.getElementById("applet_options").style.display="none")},handleggbdisable:function(){window.GGBT.ggbcheckb.checked?document.getElementById("applet_container1").style.display="block":(document.getElementById("applet_container1").style.display="none",document.getElementById("applet_options").style.display="none",window.GGBT.usefile.checked&&window.GGBT.usefile.click())},handleDragEnter:function(){("undefined"==typeof ggbcheckb||window.GGBT.ggbcheckb.checked)&&(window.GGBT.ggbf.classList.add("qtype-geogebra-hover"),document.getElementById("applet_container1").style.visibility="hidden")},handleDragOver:function(e){if(void 0===window.GGBT.ggbcheckb||window.GGBT.ggbcheckb.checked)return e.preventDefault&&e.preventDefault(),window.GGBT.ggbf.classList.add("qtype-geogebra-hover"),document.getElementById("applet_container1").style.visibility="hidden",!1},handleDragEndLeave:function(){(void 0===window.GGBT.ggbcheckb||window.GGBT.ggbcheckb.checked)&&(window.GGBT.ggbf.classList.remove("qtype-geogebra-hover"),document.getElementById("applet_container1").style.removeProperty("visibility"))},handleDrop:function(e){if(void 0===window.GGBT.ggbcheckb||window.GGBT.ggbcheckb.checked){e.preventDefault(),e.stopPropagation();var file=e.dataTransfer.files[0];window.GGBT.ggbf.classList.remove("qtype-geogebra-hover"),document.getElementById("applet_container1").style.removeProperty("visibility"),document.getElementById("applet_container1").style.display="block",document.getElementById("applet_options").style.display="flex",document.getElementById("applet_container1").style.height="100%",document.getElementById("id_ggbturl").value="",window.GGBT.usefile.checked||window.GGBT.usefile.click();var reader=new FileReader;reader.onload=function(event){var base64=event.target.result.replace("data:application/vnd.geogebra.file;base64,","");window.GGBT.parameters={ggbBase64:base64},window.GGBT.parameters.enableRightClick=window.GGBT.enable_right_click.checked,window.GGBT.parameters.enableLabelDrags=window.GGBT.enable_label_drags.checked,window.GGBT.parameters.showResetIcon=window.GGBT.show_reset_icon.checked,window.GGBT.parameters.enableShiftDragZoom=window.GGBT.enable_shift_drag_zoom.checked,window.GGBT.parameters.showAlgebraInput=window.GGBT.show_algebra_input.checked,window.GGBT.parameters.showMenuBar=window.GGBT.show_menu_bar.checked,window.GGBT.parameters.showToolBar=window.GGBT.show_tool_bar.checked,window.GGBT.parameters.moodle="editingQuestionOrSubmission",window.applet1=new GGBApplet(window.GGBT.parameters,!0),window.applet1.inject("applet_container1")},reader.readAsDataURL(file)}},isNumber:function(n){return!isNaN(parseFloat(n))&&isFinite(n)}}}));

//# sourceMappingURL=ggbt.min.js.map