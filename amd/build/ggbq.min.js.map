{"version":3,"file":"ggbq.min.js","sources":["../src/ggbq.js"],"sourcesContent":["/**\n * Javascript Controller to embed GGBApplet\n *\n * STUDENT VIEW\n *\n * This class provides all the functionality for the new assign module.\n *\n * @author         Christoph Stadlbauer <christoph.stadlbauer@geogebra.org>\n * @copyright  (c) International GeoGebra Institute 2018\n * @license        http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'https://www.geogebra.org/apps/deployggb.js'], function ($, GGBApplet) {\n    /**\n     * Created by Christoph on 25.08.19.\n     */\n\n    const scalingContainers = {};\n    let resizeTimeout;\n    /**\n     * Resizes the ggb scaling containers to make the ggb applet scale properly to fit into its container.\n     */\n    const resizeScalingContainer = () => {\n        clearTimeout(resizeTimeout);\n        resizeTimeout = setTimeout(\n            () => Object.values(scalingContainers).forEach((containerClass) => {\n                    // We need to use getElementsByClassName because colons are not allowed for jquery and Vanilla JS querySelector.\n                    const scalingContainer = document.getElementsByClassName(containerClass)[0];\n                    // We retrieve the formulation div container, because this gives us the correct width to adapt\n                    // the scaling container to.\n                    const formulationDivStyle = window.getComputedStyle(\n                        scalingContainer.querySelector('.qtext').parentElement.parentElement);\n                    scalingContainer.style.width = parseInt(formulationDivStyle.width)\n                        - parseInt(formulationDivStyle.paddingLeft) - parseInt(formulationDivStyle.paddingRight) + 'px';\n                }), 250);\n    };\n\n    return {\n        b64input: [],\n        ggbBase64: [],\n        xmlinput: [],\n        ggbxml: [],\n        currentvals: [],\n        answerinput: [],\n        responsevars: [],\n        exerciseresultinput: [],\n        qdiv: [],\n        //parameters: {},\n        ggbDataset: [],\n        //applet1,\n\n        init: function (appletParametersID) {\n            window.GGBQ = this;\n            var ggbDataset = document.getElementById(appletParametersID).dataset;\n            var slot = ggbDataset.slot;\n            // Add current scaling container to the object store for being able to access it later on.\n            scalingContainers[slot] = ggbDataset.scalingcontainerclass;\n\n            window.ggbAppletOnLoad = function (ggbAppletId) {\n                if (ggbAppletId != -1) {\n                    document.querySelector('article').onkeydown = this.checkEnter;\n                    var id = ggbAppletId.substring(9);\n                    var ggbApplet = window[ggbAppletId];\n                    var curvals = JSON.parse(window.GGBQ.currentvals[id]);\n                    for (var label in curvals) {\n                        ggbApplet.setValue(label, curvals[label]);\n                    }\n\n                    // Set the initial size of the scaling containers so GeoGebra applet scale a first time correctly after loading.\n                    resizeScalingContainer();\n                    // Unregister old event listeners in case we have multiple GeoGebra questions on one page.\n                    // We only need one for the whole page.\n                    window.removeEventListener('resize', resizeScalingContainer);\n                    window.addEventListener('resize', resizeScalingContainer);\n\n                    window.GGBQ.b64input[id].val(ggbApplet.getBase64());\n                    window.GGBQ.xmlinput[id].val(ggbApplet.getXML());\n\n                    window.GGBQ.qdiv[id].style.visibility = 'visible';\n                    if (window.GGBQ.answerinput[id].val() == '') {\n                        var responsestring = '';\n                        window.GGBQ.responsevars[id].forEach(function (responsevar) {\n                            if (ggbApplet.isDefined(responsevar)) {\n                                responsestring += ggbApplet.getValue(responsevar);\n                            } else {\n                                responsestring += 0;\n                            }\n                        });\n                        window.GGBQ.answerinput[id].val(responsestring);\n                    }\n                }\n            };\n\n            // jquery doesn't handle the colon : but later we expect a jquery optject, so ...\n            this.b64input[slot] = $(document.getElementById(ggbDataset.b64input));\n            this.ggbBase64[slot] = this.b64input[slot].val();\n\n            this.xmlinput[slot] = $(document.getElementById(ggbDataset.xmlinput));\n            this.ggbxml[slot] = this.xmlinput[slot].val();\n            this.qdiv[slot] = $(\"#q\" + (slot) + \" .qtext\")[0];\n\n            var parameters = JSON.parse(ggbDataset.parameters);\n            if (this.ggbBase64[slot] != '') {\n                parameters.ggbBase64 = this.ggbBase64[slot];\n            }\n\n            // Check if width and height have been manually set. The default would be \"no\", so we use the scaling container feature.\n            if (!ggbDataset.forcedimensions || ggbDataset.forcedimensions === '0') {\n                parameters.scaleContainerClass = scalingContainers[slot];\n                parameters.autoHeight = true;\n            } else {\n                // Width and height are specified in this case, so we use the given fixed width and height settings\n                // of the plugin instance. Form validation of the settings asserts that both width and height are being set.\n                parameters.width = ggbDataset.width;\n                parameters.height = ggbDataset.height;\n                // We need to use getElementsByClassName because colons are not allowed for jquery and Vanilla JS querySelector.\n                const scalingContainer = document.getElementsByClassName(scalingContainers[slot])[0];\n                // We should always find this container, just check to be extra safe.\n                if (scalingContainer) {\n                    // Width of the scaling container is being set after the applet has been loaded. So no need to specify it here.\n                    scalingContainer.style.overflowX = 'auto';\n                    scalingContainer.style.overflowY = 'hidden';\n                }\n            }\n\n            // parameters.currentvals = JSON.parse(ggbDataset.vars);\n            this.ggbDatasetVars = JSON.parse(ggbDataset.vars);\n            parameters.language = ggbDataset.lang;\n            parameters.moodle = \"takingQuiz\";\n            delete parameters.material_id;\n\n            parameters.id = 'ggbApplet' + slot;\n\n            var views = JSON.parse(ggbDataset.views);\n\n            var applet1 = new GGBApplet(parameters, views, ggbDataset.html5NoWebSimple);\n            // applet1.setHTML5Codebase(\"https://cdn.geogebra.org/apps/5.0.541.0/web3d\");\n            applet1.inject(ggbDataset.div, \"preferHTML5\");\n\n            $('#responseform').on('submit', this.getBase64andCheck);\n\n            $(document.getElementById(ggbDataset.div)).on('mouseleave', this.getBase64andCheck);\n\n            this.currentvals[slot] = ggbDataset.vars;\n            this.answerinput[slot] = $(document.getElementById(ggbDataset.answerinput));\n            this.exerciseresultinput[slot] = $(document.getElementById(ggbDataset.exerciseresultinput));\n            this.responsevars[slot] = JSON.parse(ggbDataset.responsevars);\n        },\n        checkEnter: function(e) {\n            e = e || event;\n            var txtArea = /textarea/i.test((e.target || e.srcElement).tagName);\n            return txtArea || (e.keyCode || e.which || e.charCode || 0) !== 13;\n        },\n\n\n        getBase64andCheck: function() {\n            for (var i = 0; i < window.GGBQ.answerinput.length; i++) {\n                var ggbApplet = window['ggbApplet' + i];\n                if (typeof ggbApplet !== \"undefined\") {\n                    window.GGBQ.b64input[i].val(ggbApplet.getBase64());\n                    window.GGBQ.xmlinput[i].val(ggbApplet.getXML());\n\n                    // Workaround, to set all randomized variables.\n                    for (const [key, value] of Object.entries(window.GGBQ.ggbDatasetVars)) {\n                        ggbApplet.evalCommand(`${key}=${value}`);\n                    }\n\n                    var responsestring = '';\n                    for (var j = 0; j < window.GGBQ.responsevars[i].length; j++) {\n                        if (ggbApplet.isDefined(window.GGBQ.responsevars[i][j])) {\n                            responsestring += ggbApplet.getValue(window.GGBQ.responsevars[i][j]);\n                        } else {\n                            responsestring += 0;\n                        }\n                    }\n\n                    window.GGBQ.answerinput[i].val(responsestring);\n                }\n            }\n        },\n\n    };\n});\n"],"names":["define","$","GGBApplet","resizeTimeout","scalingContainers","resizeScalingContainer","clearTimeout","setTimeout","Object","values","forEach","containerClass","scalingContainer","document","getElementsByClassName","formulationDivStyle","window","getComputedStyle","querySelector","parentElement","style","width","parseInt","paddingLeft","paddingRight","b64input","ggbBase64","xmlinput","ggbxml","currentvals","answerinput","responsevars","exerciseresultinput","qdiv","ggbDataset","init","appletParametersID","GGBQ","this","getElementById","dataset","slot","scalingcontainerclass","ggbAppletOnLoad","ggbAppletId","onkeydown","checkEnter","id","substring","ggbApplet","curvals","JSON","parse","label","setValue","removeEventListener","addEventListener","val","getBase64","getXML","visibility","responsestring","responsevar","isDefined","getValue","parameters","forcedimensions","height","overflowX","overflowY","scaleContainerClass","autoHeight","ggbDatasetVars","vars","language","lang","moodle","material_id","views","html5NoWebSimple","inject","div","on","getBase64andCheck","e","event","test","target","srcElement","tagName","keyCode","which","charCode","i","length","entries","key","value","evalCommand","j"],"mappings":"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"}