{"version":3,"file":"ggbq.min.js","sources":["../src/ggbq.js"],"sourcesContent":["/**\n * Javascript Controller to embed GGBApplet\n *\n * STUDENT VIEW\n *\n * This class provides all the functionality for the new assign module.\n *\n * @author         Christoph Stadlbauer <christoph.stadlbauer@geogebra.org>\n * @copyright  (c) International GeoGebra Institute 2018\n * @license        http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', '//www.geogebra.org/apps/deployggb.js'], function ($, GGBApplet) {\n    /**\n     * Created by Christoph on 25.08.19.\n     */\n\n    let resizeTimeout;\n    /**\n     * Resizes the ggb scaling containers to make the ggb applet scale properly to fit into its container.\n     */\n    const resizeScalingContainer = () => {\n        clearTimeout(resizeTimeout);\n        resizeTimeout = setTimeout(() => $(\".ggbscalingcontainer\").width($(\".qtext\").parent().parent().width(), 250));\n    };\n\n    return {\n        b64input: [],\n        ggbBase64: [],\n        xmlinput: [],\n        ggbxml: [],\n        currentvals: [],\n        answerinput: [],\n        responsevars: [],\n        exerciseresultinput: [],\n        qdiv: [],\n        //parameters: {},\n        ggbDataset: [],\n        //applet1,\n\n        init: function (appletParametersID) {\n            window.GGBQ = this;\n            var ggbDataset = document.getElementById(appletParametersID).dataset;\n            var slot = ggbDataset.slot;\n\n            window.ggbAppletOnLoad = function (ggbAppletId) {\n                if (ggbAppletId != -1) {\n                    document.querySelector('article').onkeydown = this.checkEnter;\n                    var id = ggbAppletId.substring(9);\n                    var ggbApplet = window[ggbAppletId];\n                    var curvals = JSON.parse(window.GGBQ.currentvals[id]);\n                    for (var label in curvals) {\n                        ggbApplet.setValue(label, curvals[label]);\n                    }\n\n                    // Set the initial size of the container so GeoGebra applet scales a first time correctly after loading.\n                    resizeScalingContainer();\n                    // Unregister old event listeners in case we have multiple GeoGebra questions on one page.\n                    // We only need one for the whole page.\n                    window.removeEventListener('resize', resizeScalingContainer);\n                    window.addEventListener('resize', resizeScalingContainer);\n\n                    window.GGBQ.b64input[id].val(ggbApplet.getBase64());\n                    window.GGBQ.xmlinput[id].val(ggbApplet.getXML());\n                    var numvars = ggbApplet.startExercise();\n                    for (var key in numvars) {\n                        window.GGBQ.qdiv[id].innerHTML =\n                            window.GGBQ.qdiv[id].innerHTML.replace(\"{\" + key + \"}\", numvars[key]);\n                    }\n                    window.GGBQ.qdiv[id].style.visibility = 'visible';\n\n                    if (window.GGBQ.answerinput[id].val() == '') {\n                        var responsestring = '';\n                        window.GGBQ.responsevars[id].forEach(function (responsevar) {\n                            if (ggbApplet.isDefined(responsevar)) {\n                                responsestring += ggbApplet.getValue(responsevar);\n                            } else {\n                                responsestring += 0;\n                            }\n                        });\n                        window.GGBQ.answerinput[id].val(responsestring);\n                    }\n                }\n            };\n\n            // jquery doesn't handle the colon : but later we expect a jquery optject, so ...\n            this.b64input[slot] = $(document.getElementById(ggbDataset.b64input));\n            this.ggbBase64[slot] = this.b64input[slot].val();\n\n            this.xmlinput[slot] = $(document.getElementById(ggbDataset.xmlinput));\n            this.ggbxml[slot] = this.xmlinput[slot].val();\n            this.qdiv[slot] = $(\"#q\" + (slot) + \" .qtext\")[0];\n\n            var parameters = JSON.parse(ggbDataset.parameters);\n            if (this.ggbBase64[slot] != '') {\n                parameters.ggbBase64 = this.ggbBase64[slot];\n            }\n\n            parameters.scaleContainerClass = 'ggbscalingcontainer';\n            parameters.autoHeight = true;\n\n            // parameters.currentvals = JSON.parse(ggbDataset.vars);\n            this.ggbDatasetVars = JSON.parse(ggbDataset.vars);\n            parameters.language = ggbDataset.lang;\n            parameters.moodle = \"takingQuiz\";\n            delete parameters.material_id;\n\n            parameters.id = 'ggbApplet' + slot;\n\n            var views = JSON.parse(ggbDataset.views);\n\n            var applet1 = new GGBApplet(parameters, views, ggbDataset.html5NoWebSimple);\n            // applet1.setHTML5Codebase(\"https://cdn.geogebra.org/apps/5.0.541.0/web3d\");\n            applet1.inject(ggbDataset.div, \"preferHTML5\");\n\n            $('#responseform').on('submit', this.getBase64andCheck);\n\n            $(document.getElementById(ggbDataset.div)).on('mouseleave', this.getBase64andCheck);\n\n            this.currentvals[slot] = ggbDataset.vars;\n            this.answerinput[slot] = $(document.getElementById(ggbDataset.answerinput));\n            this.exerciseresultinput[slot] = $(document.getElementById(ggbDataset.exerciseresultinput));\n            this.responsevars[slot] = JSON.parse(ggbDataset.responsevars);\n        },\n        checkEnter: function(e) {\n            e = e || event;\n            var txtArea = /textarea/i.test((e.target || e.srcElement).tagName);\n            return txtArea || (e.keyCode || e.which || e.charCode || 0) !== 13;\n        },\n\n\n        getBase64andCheck: function() {\n            for (var i = 0; i < window.GGBQ.answerinput.length; i++) {\n                var ggbApplet = window['ggbApplet' + i];\n                if (typeof ggbApplet !== \"undefined\") {\n                    window.GGBQ.b64input[i].val(ggbApplet.getBase64());\n                    window.GGBQ.xmlinput[i].val(ggbApplet.getXML());\n\n                    // Workaround, to set all randomized variables.\n                    for (const [key, value] of Object.entries(window.GGBQ.ggbDatasetVars)) {\n                        ggbApplet.evalCommand(`${key}=${value}`);\n                    }\n\n                    var responsestring = '';\n                    for (var j = 0; j < window.GGBQ.responsevars[i].length; j++) {\n                        if (ggbApplet.isDefined(window.GGBQ.responsevars[i][j])) {\n                            responsestring += ggbApplet.getValue(window.GGBQ.responsevars[i][j]);\n                        } else {\n                            responsestring += 0;\n                        }\n                    }\n\n                    window.GGBQ.answerinput[i].val(responsestring);\n                    window.GGBQ.exerciseresultinput[i].val(JSON.stringify(ggbApplet.getExerciseResult()));\n                }\n            }\n        },\n\n    };\n});\n"],"names":["define","$","GGBApplet","resizeTimeout","resizeScalingContainer","clearTimeout","setTimeout","width","parent","b64input","ggbBase64","xmlinput","ggbxml","currentvals","answerinput","responsevars","exerciseresultinput","qdiv","ggbDataset","init","appletParametersID","window","GGBQ","this","document","getElementById","dataset","slot","ggbAppletOnLoad","ggbAppletId","querySelector","onkeydown","checkEnter","id","substring","ggbApplet","curvals","JSON","parse","label","setValue","removeEventListener","addEventListener","val","getBase64","getXML","numvars","startExercise","key","innerHTML","replace","style","visibility","responsestring","forEach","responsevar","isDefined","getValue","parameters","scaleContainerClass","autoHeight","ggbDatasetVars","vars","language","lang","moodle","material_id","views","html5NoWebSimple","inject","div","on","getBase64andCheck","e","event","test","target","srcElement","tagName","keyCode","which","charCode","i","length","Object","entries","value","evalCommand","j","stringify","getExerciseResult"],"mappings":";;;;;;;;;;;miCAWAA,6BAAO,CAAC,SAAU,yCAAyC,SAAUC,EAAGC,eAKhEC,cAIEC,uBAAyB,WAC3BC,aAAaF,eACbA,cAAgBG,YAAW,kBAAML,EAAE,wBAAwBM,MAAMN,EAAE,UAAUO,SAASA,SAASD,QAAS,eAGrG,CACHE,SAAU,GACVC,UAAW,GACXC,SAAU,GACVC,OAAQ,GACRC,YAAa,GACbC,YAAa,GACbC,aAAc,GACdC,oBAAqB,GACrBC,KAAM,GAENC,WAAY,GAGZC,KAAM,SAAUC,oBACZC,OAAOC,KAAOC,SACVL,WAAaM,SAASC,eAAeL,oBAAoBM,QACzDC,KAAOT,WAAWS,KAEtBN,OAAOO,gBAAkB,SAAUC,iBACX,GAAhBA,YAAmB,CACnBL,SAASM,cAAc,WAAWC,UAAYR,KAAKS,eAC/CC,GAAKJ,YAAYK,UAAU,GAC3BC,UAAYd,OAAOQ,aACnBO,QAAUC,KAAKC,MAAMjB,OAAOC,KAAKT,YAAYoB,SAC5C,IAAIM,SAASH,QACdD,UAAUK,SAASD,MAAOH,QAAQG,QAItCnC,yBAGAiB,OAAOoB,oBAAoB,SAAUrC,wBACrCiB,OAAOqB,iBAAiB,SAAUtC,wBAElCiB,OAAOC,KAAKb,SAASwB,IAAIU,IAAIR,UAAUS,aACvCvB,OAAOC,KAAKX,SAASsB,IAAIU,IAAIR,UAAUU,cACnCC,QAAUX,UAAUY,oBACnB,IAAIC,OAAOF,QACZzB,OAAOC,KAAKL,KAAKgB,IAAIgB,UACjB5B,OAAOC,KAAKL,KAAKgB,IAAIgB,UAAUC,QAAQ,IAAMF,IAAM,IAAKF,QAAQE,SAExE3B,OAAOC,KAAKL,KAAKgB,IAAIkB,MAAMC,WAAa,UAEC,IAArC/B,OAAOC,KAAKR,YAAYmB,IAAIU,MAAa,KACrCU,eAAiB,GACrBhC,OAAOC,KAAKP,aAAakB,IAAIqB,SAAQ,SAAUC,aACvCpB,UAAUqB,UAAUD,aACpBF,gBAAkBlB,UAAUsB,SAASF,aAErCF,gBAAkB,KAG1BhC,OAAOC,KAAKR,YAAYmB,IAAIU,IAAIU,wBAMvC5C,SAASkB,MAAQ1B,EAAEuB,SAASC,eAAeP,WAAWT,gBACtDC,UAAUiB,MAAQJ,KAAKd,SAASkB,MAAMgB,WAEtChC,SAASgB,MAAQ1B,EAAEuB,SAASC,eAAeP,WAAWP,gBACtDC,OAAOe,MAAQJ,KAAKZ,SAASgB,MAAMgB,WACnC1B,KAAKU,MAAQ1B,EAAE,KAAQ0B,KAAQ,WAAW,OAE3C+B,WAAarB,KAAKC,MAAMpB,WAAWwC,YACX,IAAxBnC,KAAKb,UAAUiB,QACf+B,WAAWhD,UAAYa,KAAKb,UAAUiB,OAG1C+B,WAAWC,oBAAsB,sBACjCD,WAAWE,YAAa,OAGnBC,eAAiBxB,KAAKC,MAAMpB,WAAW4C,MAC5CJ,WAAWK,SAAW7C,WAAW8C,KACjCN,WAAWO,OAAS,oBACbP,WAAWQ,YAElBR,WAAWzB,GAAK,YAAcN,SAE1BwC,MAAQ9B,KAAKC,MAAMpB,WAAWiD,OAEpB,IAAIjE,UAAUwD,WAAYS,MAAOjD,WAAWkD,kBAElDC,OAAOnD,WAAWoD,IAAK,eAE/BrE,EAAE,iBAAiBsE,GAAG,SAAUhD,KAAKiD,mBAErCvE,EAAEuB,SAASC,eAAeP,WAAWoD,MAAMC,GAAG,aAAchD,KAAKiD,wBAE5D3D,YAAYc,MAAQT,WAAW4C,UAC/BhD,YAAYa,MAAQ1B,EAAEuB,SAASC,eAAeP,WAAWJ,mBACzDE,oBAAoBW,MAAQ1B,EAAEuB,SAASC,eAAeP,WAAWF,2BACjED,aAAaY,MAAQU,KAAKC,MAAMpB,WAAWH,eAEpDiB,WAAY,SAASyC,UACjBA,EAAIA,GAAKC,MACK,YAAYC,MAAMF,EAAEG,QAAUH,EAAEI,YAAYC,UACM,MAA7CL,EAAEM,SAAWN,EAAEO,OAASP,EAAEQ,UAAY,IAI7DT,kBAAmB,eACV,IAAIU,EAAI,EAAGA,EAAI7D,OAAOC,KAAKR,YAAYqE,OAAQD,IAAK,KACjD/C,UAAYd,OAAO,YAAc6D,WACZ,IAAd/C,UAA2B,CAClCd,OAAOC,KAAKb,SAASyE,GAAGvC,IAAIR,UAAUS,aACtCvB,OAAOC,KAAKX,SAASuE,GAAGvC,IAAIR,UAAUU,uCAGXuC,OAAOC,QAAQhE,OAAOC,KAAKuC,+CAAiB,8DAA3Db,0BAAKsC,4BACbnD,UAAUoD,sBAAevC,gBAAOsC,gBAGhCjC,eAAiB,GACZmC,EAAI,EAAGA,EAAInE,OAAOC,KAAKP,aAAamE,GAAGC,OAAQK,IAChDrD,UAAUqB,UAAUnC,OAAOC,KAAKP,aAAamE,GAAGM,IAChDnC,gBAAkBlB,UAAUsB,SAASpC,OAAOC,KAAKP,aAAamE,GAAGM,IAEjEnC,gBAAkB,EAI1BhC,OAAOC,KAAKR,YAAYoE,GAAGvC,IAAIU,gBAC/BhC,OAAOC,KAAKN,oBAAoBkE,GAAGvC,IAAIN,KAAKoD,UAAUtD,UAAUuD"}